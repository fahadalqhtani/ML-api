<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Equipment Monitoring (Live)</title>
<style>
  :root{
    --bg:#f6f8fb; --ink:#1f2937; --muted:#6b7280; --card:#ffffff; --ring:#e5e7eb;
    --ok:#ffe8d6; --warn:#fde2e2; --alert-bg:#fff8d6;
    --radius:1rem; --shadow:0 .6rem 1.5rem rgba(0,0,0,.06);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0}
  body{
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
    background:var(--bg); color:var(--ink); font-size:1rem;
    display:flex; justify-content:center; align-items:center;
  }
  .wrap{ width:95vw; height:95vh; display:grid; grid-template-columns:2fr 1fr; gap:1.5rem; }
  @media (max-width:980px){.wrap{grid-template-columns:1fr;height:auto;}}

  .panel,.alerts{ border:.1rem solid var(--ring); border-radius:var(--radius); box-shadow:var(--shadow); padding:2rem; }
  .panel{ background:var(--card); display:flex; flex-direction:column; position:relative; }
  .header{ display:flex; flex-direction:column; align-items:flex-start; gap:.75rem; margin-bottom:1rem; }
  h1{ margin:0; font-weight:900; font-size:clamp(1.5rem,2.5vw,2.4rem); letter-spacing:.02em; }

  .row{display:flex; gap:.75rem; align-items:center; flex-wrap:wrap}
  select{
    padding:.6em 1em; border-radius:.7em; border:.1rem solid var(--ring); background:#fff; font-size:1rem; min-width:14rem;
  }
  .status{ color:var(--muted); font-size:.9rem }

  .metrics{ display:grid; grid-template-columns:repeat(3,1fr); gap:1rem; margin-top:1rem; }
  @media (max-width:900px){.metrics{grid-template-columns:repeat(2,1fr);}}
  @media (max-width:500px){.metrics{grid-template-columns:1fr;}}

  .metric{
    background:#f3f6fb; border:.1rem solid var(--ring); border-radius:.9rem; text-align:center;
    padding:1.2rem; min-height:8.5rem; display:flex; flex-direction:column; justify-content:space-between;
  }
  .metric h3{margin:0;font-size:1.1rem;font-weight:700;}
  .metric .value{font-size:1.35rem;font-weight:800;margin-top:auto;}
  .last-time{ margin-top:.3rem; color:var(--muted); font-size:.85rem }

  .alerts{ background:var(--alert-bg); }
  .alerts h2{ margin:0 0 1rem; font-size:clamp(1.2rem,2vw,1.6rem); font-weight:900; }
  .alert{ background:var(--warn); border:.1rem solid #f6caca; border-radius:.8rem; padding:1rem 1.2rem; margin-top:1rem; }
  .alert.ok{ background:var(--ok); border-color:#ffd6b6; }
  .alert strong{margin-right:.4rem;}
  .time{display:block;margin-top:.3rem;color:var(--muted);font-size:.9rem;}
</style>
</head>
<body>
  <div class="wrap">
    <!-- LEFT -->
    <section class="panel" aria-label="Monitoring">
      <div class="header">
        <h1>Equipment Monitoring</h1>
        <div class="row">
          <label>
            <select id="deviceSelect" aria-label="Select equipment">
              <option disabled selected>Loading devicesâ€¦</option>
            </select>
          </label>
          <span id="liveStatus" class="status">Connectingâ€¦</span>
        </div>
      </div>

      <div class="metrics">
        <div class="metric" aria-label="Temperature">
          <h3>Temperature</h3>
          <div class="value" id="tempVal">--</div>
          <div class="last-time" id="tempTime"></div>
        </div>
        <div class="metric" aria-label="Vibration">
          <h3>Vibration</h3>
          <div class="value" id="vibVal">--</div>
          <div class="last-time" id="vibTime"></div>
        </div>
        <div class="metric" aria-label="Pressure">
          <h3>Pressure</h3>
          <div class="value" id="presVal">--</div>
          <div class="last-time" id="presTime"></div>
        </div>
      </div>
    </section>

    <!-- RIGHT -->
    <aside class="alerts" aria-label="Active alerts">
      <h2>Active Alerts</h2>
      <div class="alert ok" role="status">
        <strong>INFO:</strong> Normal operation
        <span class="time" id="infoTime">--:--:--</span>
      </div>
      <div class="alert" role="status" aria-live="assertive">
        <strong>WARNING:</strong> High vibration detected on selected device
        <span class="time" id="warnTime">--:--:--</span>
      </div>
    </aside>
  </div>

  <!-- Socket.IO client (Ù…Ù† Ø³ÙŠØ±ÙØ±Ùƒ Ù…Ø¨Ø§Ø´Ø±Ø©) -->
  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" integrity="sha384-Z4XotKqvD7Wg1MBd3b1Z9L1fH0mE5m8dM1d7D0s3y7sX78r7x1O2a4m7b4C5F6gQ" crossorigin="anonymous"></script>
  <script>
  // âœ³ï¸ Ø¹Ø¯Ù‘Ù„ Ù‡Ø°Ø§ Ù„Ùˆ Ø§Ù„Ù€ API Ø¹Ù„Ù‰ Ø¯ÙˆÙ…ÙŠÙ† Ù…Ø®ØªÙ„Ù
  const API_BASE = "https://ml-api-ec2k.onrender.com"; // Ù…Ø«Ø§Ù„: "https://ml-api-ec2k.onrender.com"
  const SEL = document.getElementById('deviceSelect');
  const liveStatus = document.getElementById('liveStatus');

  const els = {
    tempVal: document.getElementById('tempVal'),
    vibVal:  document.getElementById('vibVal'),
    presVal: document.getElementById('presVal'),
    tempTime: document.getElementById('tempTime'),
    vibTime:  document.getElementById('vibTime'),
    presTime: document.getElementById('presTime'),
    infoTime: document.getElementById('infoTime'),
    warnTime: document.getElementById('warnTime'),
  };

  /** Ø£Ø¯ÙˆØ§Øª ØµØºÙŠØ±Ø© */
  const fmt = {
    temp: v => `${Number(v).toFixed(1)} Â°C`,
    vib:  v => `${Number(v).toFixed(2)} units`,
    pres: v => `${Number(v).toFixed(0)} psi`,
    t:    d => new Date(d).toLocaleTimeString(),
  };

  /** 1) Ø­Ù…Ù‘Ù„ Ø§Ù„Ø£Ø¬Ù‡Ø²Ø© Ù…Ù† /equipment */
  async function loadDevices() {
    SEL.innerHTML = '<option disabled selected>Loading devicesâ€¦</option>';
    try {
      const res = await fetch(`${API_BASE}/equipment`, { headers: { 'Accept': 'application/json' }});
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const json = await res.json();
      const devices = Array.isArray(json?.equipment) ? json.equipment : [];
      SEL.innerHTML = '';
      if (!devices.length) {
        SEL.innerHTML = '<option disabled selected>No devices found</option>';
        return;
      }
      const ph = new Option('Select a deviceâ€¦', '', true, true);
      ph.disabled = true;
      SEL.add(ph);
      for (const name of devices) SEL.add(new Option(name, name));
    } catch (e) {
      console.error(e);
      SEL.innerHTML = '<option disabled selected>Error loading devices</option>';
    }
  }

  /** 2) Ø¹Ù†Ø¯ Ø§Ø®ØªÙŠØ§Ø± Ø¬Ù‡Ø§Ø²ØŒ Ø§Ø¬Ù„Ø¨ Ø¢Ø®Ø± Ù‚Ø±Ø§Ø¡Ø© Ù…Ù† /latest */
  async function loadLatestFor(name) {
    if (!name) return;
    try {
      const res = await fetch(`${API_BASE}/latest?equipment_name=${encodeURIComponent(name)}`);
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const { ok, data } = await res.json();
      if (ok && data) {
        els.tempVal.textContent = fmt.temp(data.temperature);
        els.vibVal.textContent  = fmt.vib (data.vibration);
        els.presVal.textContent = fmt.pres(data.pressure);

        const ts = data.timestamp || new Date().toISOString();
        els.tempTime.textContent = `Updated: ${fmt.t(ts)}`;
        els.vibTime.textContent  = `Updated: ${fmt.t(ts)}`;
        els.presTime.textContent = `Updated: ${fmt.t(ts)}`;
        els.infoTime.textContent = fmt.t(ts);
      }
    } catch (e) {
      console.error('loadLatestFor', e);
    }
  }

  /** 3) ÙˆØµÙ‘Ù„ Socket.IO ÙˆØ§Ø³ØªÙ…Ø¹ Ù„Ù€ reading_update */
  let socket;
  function connectSocket() {
    liveStatus.textContent = 'Connectingâ€¦';
    try {
      socket = io(API_BASE || undefined, {
        transports: ['websocket', 'polling'],
        // path Ø§Ù„Ø§ÙØªØ±Ø§Ø¶ÙŠ '/socket.io' â€” Ù„Ø§ ØªØºÙŠÙ‘Ø±Ù‡ Ø¥Ù„Ø§ Ø¥Ø°Ø§ Ø¹Ø¯Ù‘Ù„ØªÙ‡ ÙÙŠ Ø§Ù„Ø³ÙŠØ±ÙØ±
      });

      socket.on('connect', () => {
        liveStatus.textContent = 'Live âœ…';
      });

      socket.on('disconnect', () => {
        liveStatus.textContent = 'Disconnected. Reconnectingâ€¦';
      });

      // ðŸ“¡ ÙŠØ³ØªÙ‚Ø¨Ù„ Ø¨Ø« Ø§Ù„Ù‚Ø±Ø§Ø¡Ø© Ù…Ù† Ø§Ù„Ø³ÙŠØ±ÙØ±
      socket.on('reading_update', (msg) => {
        // msg: {equipment_name, temperature, vibration, pressure, risk_score, date}
        const selected = SEL.value;
        if (!selected || selected === '') return;          // Ù„Ù… ÙŠØ®ØªÙŽØ± Ø¨Ø¹Ø¯
        if (msg.equipment_name !== selected) return;       // Ù„ÙŠØ³ Ø§Ù„Ø¬Ù‡Ø§Ø² Ø§Ù„Ù…Ø®ØªØ§Ø±

        // Ø­Ø¯Ù‘Ø« Ø§Ù„Ù‚ÙŠÙ… ÙÙ‚Ø· Ù„Ù„Ø¬Ù‡Ø§Ø² Ø§Ù„Ù…Ø®ØªØ§Ø±
        els.tempVal.textContent = fmt.temp(msg.temperature);
        els.vibVal.textContent  = fmt.vib (msg.vibration);
        els.presVal.textContent = fmt.pres(msg.pressure);

        const ts = msg.date ? (new Date().toISOString().split('T')[0] + 'T' + msg.date) : new Date().toISOString();
        els.tempTime.textContent = `Updated: ${fmt.t(ts)}`;
        els.vibTime.textContent  = `Updated: ${fmt.t(ts)}`;
        els.presTime.textContent = `Updated: ${fmt.t(ts)}`;
        els.infoTime.textContent = fmt.t(ts);

        // Ù…Ø«Ø§Ù„ ØªÙ†Ø¨ÙŠÙ‡ Ø¨Ø³ÙŠØ· Ù„Ùˆ Ø§Ù„Ø§Ù‡ØªØ²Ø§Ø² Ø¹Ø§Ù„ÙŠ
        if (Number(msg.vibration) > 5) {
          els.warnTime.textContent = fmt.t(ts);
        }
      });

    } catch (e) {
      console.error('Socket connect error', e);
      liveStatus.textContent = 'Socket error';
    }
  }

  // Ø£Ø­Ø¯Ø§Ø« Ø§Ù„ÙˆØ§Ø¬Ù‡Ø©
  SEL.addEventListener('change', (e) => {
    const name = e.target.value;
    if (!name) return;
    loadLatestFor(name); // Ø¬Ù„Ø¨ Ø¢Ø®Ø± Ù‚Ø±Ø§Ø¡Ø© ÙÙˆØ± Ø§Ù„Ø§Ø®ØªÙŠØ§Ø±
  });

  // ØªØ´ØºÙŠÙ„
  document.addEventListener('DOMContentLoaded', async () => {
    await loadDevices();
    connectSocket();
  });
  </script>
</body>
</html>

