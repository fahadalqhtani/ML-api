<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Equipment Monitoring</title>
<style>
  :root{
    --bg:#f6f8fb; --ink:#1f2937; --muted:#6b7280; --card:#ffffff; --ring:#e5e7eb;
    --warn:#fde2e2; --alert-bg:#fff8d6;
    --radius:1rem; --shadow:0 .6rem 1.5rem rgba(0,0,0,.06);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0}
  body{
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
    background:var(--bg); color:var(--ink); font-size:1rem;
    display:flex; justify-content:center; align-items:center;
  }
  .wrap{
    width:95vw; height:95vh;
    display:grid; grid-template-columns:2fr 1fr; gap:1.5rem;
  }
  @media (max-width:980px){
    .wrap{grid-template-columns:1fr;height:auto;}
  }

  .panel,.alerts{
    border:.1rem solid var(--ring); border-radius:var(--radius);
    box-shadow:var(--shadow); padding:2rem;
  }
  .panel{
    background:var(--card); display:flex; flex-direction:column;
    justify-content:flex-start; position:relative;
  }

  /* ===== header ===== */
  .header{
    display:flex;
    flex-direction:row;
    align-items:flex-start;
    justify-content:space-between;
    gap:1rem;
    margin-bottom:2rem;
  }

  h1{
    margin:0; font-weight:900;
    font-size:clamp(1.5rem,2.5vw,2.7rem); letter-spacing:.02em;
  }

  .title-group{
    display:flex;
    flex-direction:column;
    gap:.7rem;
  }

  .controls-row{
    display:flex;
    flex-wrap:wrap;
    align-items:center;
    gap:.6rem;
  }

  select{
    min-width:220px;
    padding:.55em .9em;
    border-radius:.7em;
    border:.1rem solid var(--ring);
    background:#f9fafb;
    font-size:.95rem;
    outline:none;
  }
  select:focus{
    border-color:#2563eb;
    box-shadow:0 0 0 .14rem rgba(37,99,235,.18);
  }

  #simBtn{
    padding:.75em 1.7em;
    border-radius:999px;
    border:none;
    background:#2563eb;
    color:#fff;
    font-weight:700;
    font-size:.95rem;
    cursor:pointer;
    align-self:flex-start;
    box-shadow:0 .6rem 1.4rem rgba(37,99,235,.45);
    transition:background .15s ease, transform .15s ease, box-shadow .15s ease;
    white-space:nowrap;
  }
  #simBtn:hover:not(:disabled){
    transform:translateY(-1px);
    box-shadow:0 .6rem 1.6rem rgba(37,99,235,.55);
  }
  #simBtn:disabled{
    opacity:.6;
    cursor:default;
    box-shadow:none;
  }

  #recordsBtn{
    padding:.55em 1.1em;
    border-radius:.7em;
    border:.1rem solid var(--ring);
    background:#ffffff;
    font-size:.9rem;
    font-weight:600;
    cursor:pointer;
    transition:background .15s ease, box-shadow .15s ease, transform .15s ease;
    white-space:nowrap;
  }
  #recordsBtn:hover:not(:disabled){
    background:#e5edff;
    box-shadow:0 .3rem .9rem rgba(37,99,235,.18);
    transform:translateY(-1px);
  }
  #recordsBtn:disabled{
    opacity:.6;
    cursor:default;
  }

  /* ===== metrics cards ===== */
  .metrics{
    display:grid;
    grid-template-columns:repeat(4,minmax(0,1fr));
    gap:1rem;
  }
  @media (max-width:900px){
    .metrics{grid-template-columns:repeat(2,minmax(0,1fr));}
  }
  @media (max-width:520px){
    .metrics{grid-template-columns:1fr;}
  }

  .metric{
    background:#f3f4f6;
    border-radius:.9rem;
    padding:1.1rem 1.2rem;
    display:flex;
    flex-direction:column;
    gap:.2rem;
  }
  .metric-label{
    font-size:.9rem;
    color:var(--muted);
  }
  .metric-value{
    font-weight:800;
    font-size:1.3rem;
  }

  /* ===== records panel ===== */
  .records{
    margin-top:1.5rem;
    background:#ffffff;
    border:.1rem solid var(--ring);
    border-radius:.9rem;
    padding:1rem;
    max-height:230px;
    overflow:auto;
    font-size:.85rem;
  }
  .records.hidden{display:none;}
  .records h3{
    margin:.1rem 0 .6rem;
    font-size:.95rem;
  }
  .records-body{width:100%;}

  .records-table{
    width:100%;
    border-collapse:collapse;
    font-size:.82rem;
  }
  .records-table th,
  .records-table td{
    padding:.25rem .4rem;
    border-bottom:.05rem solid #e5e7eb;
    text-align:left;
    white-space:nowrap;
  }
  .records-table th{
    font-weight:600;
    background:#f9fafb;
    position:sticky;
    top:0;
  }

  .badge-ok{
    background:#dcfce7;
    color:#166534;
    padding:.1rem .45rem;
    border-radius:.5rem;
    font-weight:600;
    font-size:.78rem;
  }
  .badge-fail{
    background:#fee2e2;
    color:#991b1b;
    padding:.1rem .45rem;
    border-radius:.5rem;
    font-weight:600;
    font-size:.78rem;
  }

  /* ===== alerts panel ===== */
  .alerts{
    background:var(--alert-bg);
    display:flex;
    flex-direction:column;
  }
  .alerts h2{
    margin:0 0 1rem;
    font-size:clamp(1.3rem,2vw,1.8rem);
    font-weight:900;
    text-align:center;
  }
  #alertsList{
    list-style:none;
    padding:0;
    margin:0;
    overflow-y:auto;
  }

  .alert{
    background:var(--warn);
    border:.1rem solid #f6caca;
    border-radius:.8rem;
    padding:1rem 1.2rem;
    margin-top:1rem;
  }
  .alert strong{margin-right:.4rem;}
  .time{
    display:block;
    margin-top:.3rem;
    color:var(--muted);
    font-size:.9rem;
  }
</style>
</head>
<body>
<div class="wrap">
  <!-- LEFT: main panel -->
  <main class="panel" aria-label="Equipment monitoring dashboard">
    <div class="header">
      <div class="title-group">
        <h1>Equipment Monitoring</h1>

        <div class="controls-row">
          <select id="deviceSelect" aria-label="Select equipment">
            <option disabled selected>Loading devices…</option>
          </select>
          <button id="recordsBtn" type="button">Show Records</button>
        </div>
      </div>

      <button id="simBtn" type="button">Start Simulation</button>
    </div>

    <!-- metrics cards -->
    <section class="metrics" aria-label="Current readings">
      <article class="metric">
        <div class="metric-label">Temperature</div>
        <div class="metric-value" id="tempVal">--</div>
      </article>
      <article class="metric">
        <div class="metric-label">Vibration</div>
        <div class="metric-value" id="vibVal">--</div>
      </article>
      <article class="metric">
        <div class="metric-label">Pressure</div>
        <div class="metric-value" id="presVal">--</div>
      </article>
      <article class="metric">
        <div class="metric-label">Humidity</div>
        <div class="metric-value" id="humVal">--</div>
      </article>
    </section>

    <!-- records panel (hidden by default) -->
    <section id="recordsPanel" class="records hidden" aria-label="Recorded readings">
      <h3>Recorded Readings &amp; Failures</h3>
      <div id="recordsContent" class="records-body">
        <!-- filled by JS -->
      </div>
    </section>
  </main>

  <!-- RIGHT: alerts -->
  <aside class="alerts" aria-label="Active alerts">
    <h2>Active Alerts</h2>
    <ul id="alertsList"></ul>
  </aside>
</div>

<!-- Socket.IO (optional: يعمل إذا السيرفر مفعّل سوكيت) -->
<script src="https://cdn.socket.io/4.7.5/socket.io.min.js"
        integrity="sha384-PiRYlosnTDHKkVdRU1qBDIGlfLeqfO1rDBU3lBSR5I7P0KXbSL+MEsQq1Q9ctQ0"
        crossorigin="anonymous"></script>

<script>
  // غيّر الرابط إذا احتجت
  const API_BASE = "https://ml-api-ec2k.onrender.com";
  const RISK_THRESHOLD = 85;

  const sel           = document.getElementById('deviceSelect');
  const simBtn        = document.getElementById('simBtn');
  const alertsList    = document.getElementById('alertsList');
  const recordsBtn    = document.getElementById('recordsBtn');
  const recordsPanel  = document.getElementById('recordsPanel');
  const recordsContent= document.getElementById('recordsContent');

  const els = {
    temp: document.getElementById('tempVal'),
    vib : document.getElementById('vibVal'),
    pres: document.getElementById('presVal'),
    hum : document.getElementById('humVal'),
  };

  const fmt = {
    temp: v => `${Number(v).toFixed(1)} °C`,
    vib : v => `${Number(v).toFixed(2)} units`,
    pres: v => `${Number(v).toFixed(0)} psi`,
    hum : v => `${Number(v).toFixed(1)} %`,
    clock: () => new Date().toLocaleTimeString('en-US', { hour12: true }),
  };

  let socket     = null;
  let pollTimer  = null;
  let simRunning = false;
  let recordsVisible = false;

  // ========== API helpers ==========
  async function fetchJSON(url){
    const res = await fetch(url);
    if(!res.ok) throw new Error(`HTTP ${res.status}`);
    const json = await res.json();
    if(json.ok === false) throw new Error(json.error || 'API error');
    return json;
  }

  async function loadDevices(){
    try{
      const json = await fetchJSON(`${API_BASE}/equipment`);
      const list = json.equipment || [];
      sel.innerHTML = '';
      if(!list.length){
        sel.innerHTML = '<option disabled selected>No devices found</option>';
        simBtn.disabled = true;
        recordsBtn.disabled = true;
        return;
      }
      for(const name of list){
        const opt = document.createElement('option');
        opt.value = name;
        opt.textContent = name;
        sel.appendChild(opt);
      }
      sel.selectedIndex = 0;
      simBtn.disabled = false;
      recordsBtn.disabled = false;
      await updateSelectedCards('initial-load');
    }catch(err){
      console.error('loadDevices:', err);
      sel.innerHTML = '<option disabled selected>Failed to load devices</option>';
      simBtn.disabled = true;
      recordsBtn.disabled = true;
    }
  }

  async function fetchLatest(name){
    const json = await fetchJSON(`${API_BASE}/latest?equipment_name=${encodeURIComponent(name)}`);
    return json.data || null;
  }

  async function fetchRecords(name){
    try{
      const json = await fetchJSON(`${API_BASE}/records?equipment_name=${encodeURIComponent(name)}&limit=50`);
      return json.data || [];
    }catch(err){
      console.error('fetchRecords:', err);
      alert('Could not load records for this device.');
      return [];
    }
  }

  // ========== UI helpers ==========
  function setMetricsFromReading(r){
    if(!r){
      els.temp.textContent = els.vib.textContent = els.pres.textContent = els.hum.textContent = '--';
      return;
    }
    els.temp.textContent = fmt.temp(r.temperature);
    els.vib.textContent  = fmt.vib(r.vibration);
    els.pres.textContent = fmt.pres(r.pressure);
    els.hum.textContent  = fmt.hum(r.humidity);
  }

  function pushAlertIfNeeded(name, reading){
    if(!reading) return;
    const risk = Number(reading.risk_score || 0);
    const isFail = reading.prediction === 1 || risk >= RISK_THRESHOLD;
    if(!isFail) return;

    const li = document.createElement('li');
    li.className = 'alert';

    const msg = reading.message || 'High risk detected';
    const timeStr = reading.timestamp
      ? new Date(reading.timestamp).toLocaleString('en-US', { hour12:true })
      : fmt.clock();

    li.innerHTML = `
      <strong>${name}</strong> – ${msg}
      <span class="time">${timeStr} • Risk: ${risk}%</span>
    `;

    alertsList.prepend(li);
    // حد أقصى 20 تنبيه
    while(alertsList.children.length > 20){
      alertsList.removeChild(alertsList.lastChild);
    }
  }

  function renderRecords(rows){
    if (!rows.length){
      recordsContent.innerHTML = '<p>No records found for this device yet.</p>';
      return;
    }

    let html = `
      <table class="records-table">
        <thead>
          <tr>
            <th>Time</th>
            <th>Temp</th>
            <th>Vib</th>
            <th>Pres</th>
            <th>Hum</th>
            <th>Risk</th>
            <th>Status</th>
            <th>Message</th>
          </tr>
        </thead>
        <tbody>
    `;

    for(const r of rows){
      const t = r.timestamp
        ? new Date(r.timestamp).toLocaleTimeString('en-US', { hour12:true })
        : '';
      const risk = Math.round((r.probability || 0) * 100);
      const isFail = r.prediction === 1;
      const statusText = isFail ? 'Failure' : 'Normal';
      const badgeClass = isFail ? 'badge-fail' : 'badge-ok';

      html += `
        <tr>
          <td>${t}</td>
          <td>${Number(r.temperature).toFixed(1)}</td>
          <td>${Number(r.vibration).toFixed(2)}</td>
          <td>${Number(r.pressure).toFixed(0)}</td>
          <td>${Number(r.humidity).toFixed(1)}</td>
          <td>${risk}%</td>
          <td><span class="${badgeClass}">${statusText}</span></td>
          <td>${r.message || ''}</td>
        </tr>
      `;
    }

    html += '</tbody></table>';
    recordsContent.innerHTML = html;
  }

  async function updateSelectedCards(source){
    const name = sel.value;
    if(!name) return;
    try{
      const reading = await fetchLatest(name);
      setMetricsFromReading(reading);
      if(source !== 'manual-no-alert'){
        pushAlertIfNeeded(name, reading);
      }
    }catch(err){
      console.error('updateSelectedCards:', err);
    }
  }

  // ========== Polling ==========
  function startPolling(){
    if(pollTimer) return;
    pollTimer = setInterval(() => {
      updateSelectedCards('poll');
    }, 5000);
  }
  function stopPolling(){
    if(!pollTimer) return;
    clearInterval(pollTimer);
    pollTimer = null;
  }

  // ========== Socket.IO (اختياري) ==========
  function connectSocket(){
    if(!window.io){
      console.warn('Socket.IO not found – using polling only');
      return;
    }
    try{
      socket = io(API_BASE, {
        withCredentials:false,
        transports:['websocket','polling'],
      });
      socket.on('connect', () => {
        console.log('[Socket] connected');
      });
      socket.on('disconnect', () => {
        console.log('[Socket] disconnected');
      });
      socket.on('reading_update', payload => {
        const { equipment_name, reading } = payload || {};
        if(!equipment_name || !reading) return;
        if(equipment_name === sel.value){
          setMetricsFromReading(reading);
        }
        pushAlertIfNeeded(equipment_name, reading);
      });
    }catch(err){
      console.error('socket error:', err);
    }
  }

  // ========== Event handlers ==========
  sel.addEventListener('change', async () => {
    els.temp.textContent = els.vib.textContent = els.pres.textContent = els.hum.textContent = '--';
    recordsPanel.classList.add('hidden');
    recordsVisible = false;
    recordsBtn.textContent = 'Show Records';
    await updateSelectedCards('select-change');
  });

  simBtn.addEventListener('click', async () => {
    if(!simRunning){
      simRunning = true;
      simBtn.textContent = 'Stop Simulation';
      await updateSelectedCards('manual-no-alert');
      startPolling();
    }else{
      simRunning = false;
      simBtn.textContent = 'Start Simulation';
      stopPolling();
    }
  });

  recordsBtn.addEventListener('click', async () => {
    const name = sel.value;
    if(!name){
      alert('Please select a device first.');
      return;
    }

    if(!recordsVisible){
      recordsBtn.disabled = true;
      recordsBtn.textContent = 'Loading…';
      const rows = await fetchRecords(name);
      renderRecords(rows);
      recordsPanel.classList.remove('hidden');
      recordsVisible = true;
      recordsBtn.disabled = false;
      recordsBtn.textContent = 'Hide Records';
    }else{
      recordsPanel.classList.add('hidden');
      recordsVisible = false;
      recordsBtn.textContent = 'Show Records';
    }
  });

  document.addEventListener('DOMContentLoaded', async () => {
    await loadDevices();
    connectSocket();  // يعمل لو مفعّل في الباك إند
  });
</script>
</body>
</html>
