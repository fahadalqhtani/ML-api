<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Equipment Monitoring</title>
<style>
  :root{
    --bg:#f6f8fb; --ink:#1f2937; --muted:#6b7280; --card:#ffffff; --ring:#e5e7eb;
    --ok:#ffe8d6; --warn:#fde2e2; --alert-bg:#fff8d6;
    --radius:1rem; --shadow:0 .6rem 1.5rem rgba(0,0,0,.06);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0}
  body{
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
    background:var(--bg); color:var(--ink); font-size:1rem;
    display:flex; justify-content:center; align-items:center;
  }
  .wrap{ width:95vw; height:95vh; display:grid; grid-template-columns:2fr 1fr; gap:1.5rem; }
  @media (max-width:980px){.wrap{grid-template-columns:1fr;height:auto;}}

  .panel,.alerts{ border:.1rem solid var(--ring); border-radius:var(--radius); box-shadow:var(--shadow); padding:2rem; }
  .panel{ background:var(--card); display:flex; flex-direction:column; justify-content:space-between; position:relative; }
  .header{ display:flex; flex-direction:column; align-items:flex-start; position:relative; margin-bottom:2rem; }
  h1{ margin:0; font-weight:900; font-size:clamp(1.5rem,2.5vw,2.7rem); letter-spacing:.02em; }

  select{
    padding:.6em 1em; border-radius:.7em; border:.1rem solid var(--ring); background:#fff; font-size:1rem;
    margin-top:2.5rem; margin-left:.2rem; min-width:14rem;
  }

  .metrics{ display:grid; grid-template-columns:repeat(3,1fr); gap:1rem; margin-top:2rem; }
  @media (max-width:900px){.metrics{grid-template-columns:repeat(2,1fr);}}
  @media (max-width:500px){.metrics{grid-template-columns:1fr;}}

  .metric{
    background:#f3f6fb; border:.1rem solid var(--ring); border-radius:.9rem; text-align:center;
    padding:1.4rem; min-height:10rem; display:flex; flex-direction:column; justify-content:space-between;
    transition:transform .2s ease;
  }
  .metric:hover{transform:translateY(-.2rem);}
  .metric h3{margin:0;font-size:1.2rem;font-weight:700;}
  .metric .value{font-size:1.4rem;font-weight:800;margin-top:auto;}

  .alerts{ background:var(--alert-bg); }
  .alerts h2{ margin:0 0 1rem; font-size:clamp(1.3rem,2vw,1.8rem); font-weight:900; }
  .alert{ background:var(--warn); border:.1rem solid #f6caca; border-radius:.8rem; padding:1rem 1.2rem; margin-top:1rem; }
  .alert.ok{ background:var(--ok); border-color:#ffd6b6; }
  .alert strong{margin-right:.4rem;}
  .time{display:block;margin-top:.3rem;color:var(--muted);font-size:.9rem;}
</style>
</head>
<body>
  <div class="wrap">
    <!-- Left panel -->
    <section class="panel" aria-label="Monitoring">
      <div class="header">
        <h1>Equipment Monitoring</h1>
        <label>
          <select id="deviceSelect" aria-label="Select equipment">
            <option disabled selected>Loading devices…</option>
          </select>
        </label>
      </div>

      <div class="metrics">
        <div class="metric" aria-label="Temperature">
          <h3>Temperature</h3>
          <div class="value" id="tempVal">--</div>
        </div>
        <div class="metric" aria-label="Vibration">
          <h3>Vibration</h3>
          <div class="value" id="vibVal">--</div>
        </div>
        <div class="metric" aria-label="Pressure">
          <h3>Pressure</h3>
          <div class="value" id="presVal">--</div>
        </div>
      </div>
    </section>

    <!-- Right panel -->
    <aside class="alerts" aria-label="Active alerts">
      <h2>Active Alerts</h2>

      <div class="alert ok" role="status">
        <strong>INFO:</strong> Normal operation
        <span class="time">1:15:38 PM</span>
      </div>

      <div class="alert" role="status" aria-live="assertive">
        <strong>WARNING:</strong> High vibration detected on Pump 101
        <span class="time">1:15:38 PM</span>
      </div>
    </aside>
  </div>

<script src="https://cdn.socket.io/4.7.5/socket.io.min.js" crossorigin="anonymous"></script>
<script>
const API_BASE = "https://ml-api-ec2k.onrender.com";

const sel = document.getElementById('deviceSelect');
const els = {
  temp: document.getElementById('tempVal'),
  vib : document.getElementById('vibVal'),
  pres: document.getElementById('presVal'),
};
const fmt = {
  temp: v => `${Number(v).toFixed(1)} °C`,
  vib : v => `${Number(v).toFixed(2)} units`,
  pres: v => `${Number(v).toFixed(0)} psi`,
};

// 1) دالة تطبيع أسماء الأجهزة (frontend فقط)
function slug(s){
  return String(s||'')
    .toLowerCase()
    .normalize('NFKD')                // يسهّل إزالة التشكيل
    .replace(/[\u0300-\u036f]/g,'')   // إزالة التشكيل
    .replace(/[^a-z0-9]+/g,'')        // إزالة كل ما عدا أرقام/حروف لاتينية
    .trim();
}
// نسمح بأن الاسم الوارد يبدأ/ينتهي بالآخر (Pump ↔ Pump101)
function isSameDeviceName(a,b){
  const A = slug(a), B = slug(b);
  if(!A || !B) return false;
  return A===B || A.startsWith(B) || B.startsWith(A);
}

let socket = null;

// 2) تحميل الأجهزة مرة واحدة (لا يوجد polling)
async function loadDevices() {
  sel.innerHTML = '<option disabled selected>Loading devices…</option>';
  try {
    const res = await fetch(`${API_BASE}/equipment`, { headers: { 'Accept': 'application/json' } });
    const json = await res.json();
    const devices = Array.isArray(json?.equipment) ? json.equipment : [];
    sel.innerHTML = '';
    if (!devices.length) {
      sel.innerHTML = '<option disabled selected>No devices found</option>';
      return;
    }
    // اعرض الأسماء كما هي من الـAPI
    for (const name of devices) sel.add(new Option(name, name));
    sel.selectedIndex = 0;
  } catch (e) {
    console.error('Failed to load devices:', e);
    sel.innerHTML = '<option disabled selected>Error loading devices</option>';
  }
}

// 3) اتصال السوكِت فقط (بدون أي setInterval)
function connectSocket(){
  if (!window.io) { console.error('Socket.IO not loaded'); return; }

  socket = io(API_BASE, {
    withCredentials: false,
    timeout: 10000,
    reconnection: true,
    reconnectionAttempts: Infinity,
    reconnectionDelayMax: 5000,
    path: '/socket.io'
  });

  // لوجر عام لكل الأحداث لمعرفة وش قاعد يوصل فعلاً
  socket.onAny((event, ...args) => {
    if (event !== 'pong') { // تجاهل نبضات الحياة إن وجدت
      console.log('[Socket][ANY]', event, ...args);
    }
  });

  socket.on('connect', () => {
    console.log('[Socket] connected', socket.id);
  });
  socket.on('connect_error', (e) => console.warn('[Socket] connect_error:', e?.message||e));
  socket.on('disconnect', (r) => console.warn('[Socket] disconnected:', r));

  // استلام التحديثات الفورية
  socket.on('reading_update', (msg) => {
    const selectedName = sel.value;            // الاسم الحالي من القائمة
    const incomingName = msg?.equipment_name;  // الاسم القادم من السيرفر
    if (!isSameDeviceName(incomingName, selectedName)) return;

    console.log('[Socket] update for', incomingName, msg);
    els.temp.textContent = fmt.temp(msg.temperature);
    els.vib .textContent = fmt.vib (msg.vibration);
    els.pres.textContent = fmt.pres(msg.pressure);
  });
}

// 4) عند تغيير الجهاز: لا polling—فقط نعيد القيم لـ "--" حتى يصل push القادم
sel.addEventListener('change', () => {
  els.temp.textContent = els.vib.textContent = els.pres.textContent = '--';
  // لا نطلق fetch دوري. التحديث سيصل عبر reading_update تلقائياً.
});

document.addEventListener('DOMContentLoaded', async () => {
  await loadDevices();  // يملأ القائمة فقط
  connectSocket();      // يعتمد كليًا على push من السوكِت
});
</script>





</body>
</html>






