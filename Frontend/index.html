<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Equipment Monitoring</title>
<style>
  :root{
    --bg:#f6f8fb; --ink:#1f2937; --muted:#6b7280; --card:#ffffff; --ring:#e5e7eb;
    --warn-bg:#fef2f2; --warn-border:#fecaca; --warn-pill:#b91c1c; --warn-text:#7f1d1d;
    --alert-bg:#fff8d6;
    --radius:1rem; --shadow:0 .6rem 1.5rem rgba(0,0,0,.06);
  }
  *{box-sizing:border-box}
  html,body{margin:0;padding:0}
  body{
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
    background:var(--bg); color:var(--ink); font-size:1rem;
    display:flex;
    flex-direction:column;
    align-items:center;
    padding:1.5rem 0;
  }

  .wrap{
    width:95vw;
    min-height:60vh;
    display:grid;
    grid-template-columns:2fr 1fr;
    gap:1.5rem;
  }
  @media (max-width:980px){
    .wrap{
      grid-template-columns:1fr;
      min-height:auto;
    }
  }

  .panel,.alerts{
    border:.1rem solid var(--ring); border-radius:var(--radius);
    box-shadow:var(--shadow); padding:2rem;
    background:var(--card);
  }
  .panel{
    display:flex; flex-direction:column;
    justify-content:space-between; position:relative;
  }

  /* ===== header ===== */
  .header{
    display:flex;
    flex-direction:row;
    align-items:flex-start;
    justify-content:space-between;
    gap:1rem;
    margin-bottom:2rem;
  }

  h1{
    margin:0; font-weight:900;
    font-size:clamp(1.5rem,2.5vw,2.7rem); letter-spacing:.02em;
  }

  .title-group{
    display:flex;
    flex-direction:column;
    gap:.75rem;
  }

  .controls-row{
    display:flex;
    flex-wrap:wrap;
    gap:.75rem;
    align-items:center;
  }

  select{
    padding:.6em 1em; border-radius:.7em; border:.1rem solid var(--ring);
    background:#fff; font-size:1rem; min-width:14rem;
  }

  #simBtn{
    padding:.7em 1.4em;
    border-radius:.8em;
    border:none;
    background:#2563eb;
    color:#fff;
    font-size:1rem;
    font-weight:600;
    cursor:pointer;
    box-shadow:0 .3rem .9rem rgba(37,99,235,.25);
    transition:background .15s ease, transform .15s ease, box-shadow .15s ease;
    white-space:nowrap;
  }
  #simBtn:hover{
    background:#1d4ed8;
    transform:translateY(-1px);
    box-shadow:0 .6rem 1.4rem rgba(37,99,235,.35);
  }
  #simBtn:disabled{
    opacity:.6;
    cursor:default;
    box-shadow:none;
  }

  /* ===== metric cards ===== */
  .metrics{
    display:grid;
    grid-template-columns:repeat(4,1fr);
    gap:1rem;
    margin-top:2rem;
  }
  @media (max-width:1100px){.metrics{grid-template-columns:repeat(2,1fr);}}
  @media (max-width:600px){.metrics{grid-template-columns:1fr;}}

  .metric{
    background:#f3f6fb; border:.1rem solid var(--ring); border-radius:.9rem;
    text-align:center; padding:1.4rem; min-height:10rem;
    display:flex; flex-direction:column; justify-content:space-between;
    transition:transform .2s ease;
  }
  .metric:hover{transform:translateY(-.2rem);}
  .metric h3{margin:0;font-size:1.2rem;font-weight:700;}
  .metric .value{font-size:1.4rem;font-weight:800;margin-top:auto;}

  /* ===== Active Alerts ===== */
  .alerts{
    background:var(--alert-bg);
    display:flex;
    flex-direction:column;
  }
  .alerts h2{
    margin:0 0 1rem;
    font-size:clamp(1.3rem,2vw,1.8rem);
    font-weight:900;
    text-align:center;
  }
  #alertsList{
    flex:1;
    overflow-y:auto;
  }
  .alert-empty{
    text-align:center;
    color:var(--muted);
    font-size:.95rem;
  }
  .alert-item{
    background:var(--warn-bg);
    border:.1rem solid var(--warn-border);
    border-radius:.9rem;
    padding:1rem 1.1rem;
    margin-bottom:.8rem;
  }
  .alert-header{
    display:flex;
    justify-content:space-between;
    align-items:center;
    margin-bottom:.3rem;
  }
  .alert-device{
    margin:0;
    font-weight:700;
  }
  .alert-pill{
    background:var(--warn-pill);
    color:#fff;
    font-size:.75rem;
    padding:.15rem .6rem;
    border-radius:999px;
    font-weight:700;
    text-transform:uppercase;
    letter-spacing:.04em;
  }
  .alert-msg{
    margin:.1rem 0 0;
    font-size:.95rem;
    color:var(--warn-text);
    font-weight:500;
  }
  .time{
    display:block;
    margin-top:.35rem;
    color:var(--muted);
    font-size:.85rem;
  }

  /* ===== Records panel ===== */
  .records{
    margin-top:1rem;
    width:95vw;
    background:var(--card);
    border:.1rem solid var(--ring);
    border-radius:var(--radius);
    box-shadow:var(--shadow);
    padding:1rem 1.5rem 1.25rem;
    max-height:260px;
    display:flex;
    flex-direction:column;
    gap:.6rem;
  }

  .records-header{
    display:flex;
    flex-wrap:wrap;
    justify-content:space-between;
    align-items:baseline;
    gap:.4rem .75rem;
  }
  .records-header h3{
    margin:0;
    font-size:1rem;
    font-weight:700;
  }
  .records-sub{
    margin:0;
    font-size:.85rem;
    color:var(--muted);
  }

  .records-scroll{overflow:auto;}

  .records-table{
    width:100%;
    border-collapse:collapse;
    font-size:.8rem;
  }
  .records-table th,
  .records-table td{
    padding:.35rem .5rem;
    border-bottom:.05rem solid #e5e7eb;
    text-align:left;
    vertical-align:top;
  }
  .records-table th{
    font-weight:700;
    background:#f9fafb;
    position:sticky;
    top:0;
    z-index:1;
  }
  .records-table tr.row-fail{
    background:rgba(248,113,113,.08);
  }
  .records-table tr.row-fail td:nth-child(6),
  .records-table tr.row-fail td:nth-child(7){
    font-weight:700;
  }

  @media (max-width:980px){
    .records{width:95vw;}
    .header{
      flex-direction:column;
      align-items:flex-start;
      gap:1rem;
    }
  }
</style>
</head>
<body>
  <div class="wrap">
    <!-- Left panel -->
    <section class="panel" aria-label="Monitoring">
      <div class="header">
        <div class="title-group">
          <h1>Equipment Monitoring</h1>
          <div class="controls-row">
            <select id="deviceSelect" aria-label="Select equipment">
              <option disabled selected>Loading devices…</option>
            </select>
          </div>
        </div>
        <button id="simBtn" type="button">Start Simulation</button>
      </div>

      <div class="metrics">
        <div class="metric" aria-label="Temperature">
          <h3>Temperature</h3>
          <div class="value" id="tempVal">--</div>
        </div>
        <div class="metric" aria-label="Vibration">
          <h3>Vibration</h3>
          <div class="value" id="vibVal">--</div>
        </div>
        <div class="metric" aria-label="Pressure">
          <h3>Pressure</h3>
          <div class="value" id="presVal">--</div>
        </div>
        <div class="metric" aria-label="Humidity">
          <h3>Humidity</h3>
          <div class="value" id="humVal">--</div>
        </div>
      </div>
    </section>

    <!-- Right panel -->
    <aside class="alerts" aria-label="Active alerts">
      <h2>Active Alerts</h2>
      <div id="alertsList"></div>
    </aside>
  </div>

  <!-- Records panel (always visible) -->
  <section id="recordsPanel" class="records" aria-label="Recorded readings">
    <div class="records-header">
      <h3>Recorded Readings &amp; Failures</h3>
      <p class="records-sub">Shows last 50 records for the selected equipment (from Postgres / prediction table).</p>
    </div>
    <div id="recordsContent" class="records-scroll">
      <!-- JS will fill -->
    </div>
  </section>

  <script>
  // ======== CONFIG ========
  const API_BASE = "https://ml-api-ec2k.onrender.com"; // عدّلها لو عندك URL مختلف
  const RISK_THRESHOLD = 85;

  const sel = document.getElementById('deviceSelect');
  const alertsList = document.getElementById('alertsList');
  const simBtn = document.getElementById('simBtn');
  const recordsContent = document.getElementById('recordsContent');

  const els = {
    temp: document.getElementById('tempVal'),
    vib : document.getElementById('vibVal'),
    pres: document.getElementById('presVal'),
    hum : document.getElementById('humVal'),
  };

  const fmt = {
    temp: v => `${Number(v).toFixed(1)} °C`,
    vib : v => `${Number(v).toFixed(2)} units`,
    pres: v => `${Number(v).toFixed(0)} psi`,
    hum : v => `${Number(v).toFixed(1)} %`,
    clock: () => new Date().toLocaleTimeString('en-US', { hour12: true }),
  };

  let devices = [];
  const alertsMap = new Map();
  let simRunning = false;
  let pollTimer = null;

  // ======== Records table ========
  function renderRecordsTable(rows){
    if (!rows || !rows.length){
      recordsContent.innerHTML =
        '<p style="margin:0;color:var(--muted);font-size:.9rem;">No records found for this equipment yet.</p>';
      return;
    }

    const header = `
      <thead>
        <tr>
          <th>Time</th>
          <th>Temp (°C)</th>
          <th>Vibration</th>
          <th>Pressure (psi)</th>
          <th>Humidity (%)</th>
          <th>Prediction</th>
          <th>Risk</th>
          <th>Message</th>
        </tr>
      </thead>`;

    const body = rows.map(r => {
     const timeStr = new Date(r.timestamp).toLocaleString('en-US', {
      year: 'numeric',
      month: 'short',
      day: '2-digit',
      hour: '2-digit',
      minute: '2-digit',
      second: '2-digit',
      hour12: true,
    });

      return `
        <tr class="${Number(r.prediction) === 1 ? 'row-fail' : ''}">
          <td>${timeStr}</td>
          <td>${Number(r.temperature).toFixed(1)}</td>
          <td>${Number(r.vibration).toFixed(2)}</td>
          <td>${Number(r.pressure).toFixed(0)}</td>
          <td>${Number(r.humidity).toFixed(1)}</td>
          <td>${Number(r.prediction) === 1 ? 'Failure' : 'Normal'}</td>
          <td>${(Number(r.probability) * 100).toFixed(0)}%</td>
          <td>${r.message ?? ''}</td>
        </tr>`;
    }).join('');

    recordsContent.innerHTML = `
      <div class="records-scroll">
        <table class="records-table">
          ${header}
          <tbody>${body}</tbody>
        </table>
      </div>`;
  }

  async function fetchRecordsForSelected(){
    const name = (sel.value || '').trim();
    if (!name || name.startsWith('Loading') || name.startsWith('Could not')){
      recordsContent.innerHTML =
        '<p style="margin:0;color:var(--muted);font-size:.9rem;">Please select an equipment first.</p>';
      return;
    }

    try{
      const res = await fetch(
        `${API_BASE}/records?equipment_name=${encodeURIComponent(name)}&limit=50`
      );
      if (!res.ok) throw new Error(`HTTP ${res.status}`);
      const { ok, data } = await res.json();
      if (ok){
        renderRecordsTable(data || []);
      } else {
        recordsContent.innerHTML =
          '<p style="margin:0;color:var(--muted);font-size:.9rem;">Could not load records.</p>';
      }
    } catch(err){
      console.error('records error:', err);
      recordsContent.innerHTML =
        '<p style="margin:0;color:var(--muted);font-size:.9rem;">Error loading records.</p>';
    }
  }

  // ======== Alerts UI ========
  function renderAlerts(){
  alertsList.innerHTML = '';
  const alerts = Array.from(alertsMap.values());
  if (!alerts.length){
    const p = document.createElement('p');
    p.className = 'alert-empty';
    p.textContent = 'No active alerts.';
    alertsList.appendChild(p);
    return;
  }

  alerts
    .sort((a,b) => b._ts - a._ts)
    .forEach(a => {
      const div = document.createElement('div');
      div.className = 'alert-item';
      div.innerHTML = `
        <div class="alert-header">
          <span class="alert-pill">WARNING</span>
        </div>
        <p class="alert-msg">${a.message || 'Abnormal condition detected.'}</p>
        <span class="time">${a.time}</span>
      `;
      alertsList.appendChild(div);
    });
}


  function upsertAlert(name, timeStr, message){
    alertsMap.set(name, { name, time: timeStr, message, _ts: Date.now() });
    renderAlerts();
  }

  function clearAlert(name){
    if (alertsMap.delete(name)) renderAlerts();
  }

  // ======== API helpers ========
  async function fetchLatest(name){
    try{
      const res = await fetch(`${API_BASE}/latest?equipment_name=${encodeURIComponent(name)}`);
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const { ok, data } = await res.json();
      if (ok && data) return data;
      return null;
    } catch (err) {
      console.error('latest error:', err);
      return null;
    }
  }

  async function updateSelectedCards(source = 'poll'){
    const name = (sel.value || '').trim();
    if (!name || name.startsWith('Loading') || name.startsWith('Could not')) return;

    const data = await fetchLatest(name);
    if (!data) return;

    els.temp.textContent = fmt.temp(data.temperature);
    els.vib .textContent = fmt.vib (data.vibration);
    els.pres.textContent = fmt.pres(data.pressure);
    els.hum .textContent = fmt.hum (data.humidity);

    const risk = Number(data.risk_score || 0);
    const prediction = Number(data.prediction || 0);
    const timeStr = new Date(data.timestamp || Date.now())
      .toLocaleTimeString('en-US',{hour12:true});

    if (risk >= RISK_THRESHOLD || prediction === 1) {
      upsertAlert(name, timeStr, data.message);
    } else {
      clearAlert(name);
    }

    // جدول القراءات يتحدث مع كل مرة نستدعي فيها هذه الدالة
    await fetchRecordsForSelected();
  }

  async function refreshAlertsForAllDevices(){
    for (const name of devices){
      const data = await fetchLatest(name);
      if (!data) {
        clearAlert(name);
        continue;
      }
      const risk = Number(data.risk_score || 0);
      const prediction = Number(data.prediction || 0);
      const timeStr = data.timestamp
        ? new Date(data.timestamp).toLocaleTimeString('en-US',{hour12:true})
        : fmt.clock();
      if (risk >= RISK_THRESHOLD || prediction === 1) {
        upsertAlert(name, timeStr, data.message);
      } else {
        clearAlert(name);
      }
    }
  }

  // ======== Polling فقط ========
  function startPolling(){
    if (pollTimer) return;
    pollTimer = setInterval(async () => {
      await updateSelectedCards('poll');
      await refreshAlertsForAllDevices();
    }, 5000); // كل 5 ثواني
  }

  // ======== Simulation زر ========
  simBtn.addEventListener('click', async () => {
    const action = simRunning ? 'stop' : 'start';
    simBtn.disabled = true;

    try {
      const res = await fetch(`${API_BASE}/simulation/${action}`, { method: 'POST' });
      const json = await res.json().catch(() => ({}));

      if (!res.ok || json.ok === false) {
        alert('Simulation request failed.\nCheck /simulation logs on Render.');
        return;
      }

      simRunning = !simRunning;
      simBtn.textContent = simRunning ? 'Stop Simulation' : 'Start Simulation';
      simBtn.style.background = simRunning ? '#dc2626' : '#2563eb';
    } catch (err) {
      console.error('Simulation toggle error:', err);
      alert('Could not reach the API server.\nIs your Render service running?');
    } finally {
      simBtn.disabled = false;
    }
  });

  // ======== Load devices ========
  async function loadDevices() {
    const setOpt = (txt) => sel.innerHTML = `<option disabled selected>${txt}</option>`;

    for (let i = 1; i <= 5; i++){
      try {
        const res = await fetch(`${API_BASE}/equipment`);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const { ok, equipment } = await res.json();
        if (!ok) throw new Error('Backend returned ok:false');
        devices = equipment || [];
        if (!devices.length) throw new Error('No equipment in DB');

        sel.innerHTML = devices
          .map((name, idx) =>
            `<option value="${name}" ${idx===0?'selected':''}>${name}</option>`
          ).join('');

        await updateSelectedCards('initial');
        await refreshAlertsForAllDevices();
        return;
      } catch (e) {
        console.warn(`[loadDevices] try ${i} failed:`, e?.message || e);
        setOpt(i === 1 ? 'Warming up server…' : `Retrying… (${i}/5)`);
        await new Promise(r => setTimeout(r, i * 1000));
      }
    }

    setOpt('Could not load devices (server waking up)…');
  }

  sel.addEventListener('change', async () => {
    els.temp.textContent = els.vib.textContent =
      els.pres.textContent = els.hum.textContent = '--';
    await updateSelectedCards('select-change');
  });

  document.addEventListener('DOMContentLoaded', async () => {
    await loadDevices();
    startPolling();   // فقط polling
  });
  </script>
</body>
</html>

