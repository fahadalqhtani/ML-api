<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Equipment Monitoring</title>
<style>
  :root{
    --bg:#f6f8fb; --ink:#1f2937; --muted:#6b7280; --card:#ffffff; --ring:#e5e7eb;
    --warn:#fde2e2; --alert-bg:#fff8d6;
    --radius:1rem; --shadow:0 .6rem 1.5rem rgba(0,0,0,.06);
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0}
  body{
    font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial;
    background:var(--bg); color:var(--ink); font-size:1rem;
    display:flex; justify-content:center; align-items:center;
  }
  .wrap{ width:95vw; height:95vh; display:grid; grid-template-columns:2fr 1fr; gap:1.5rem; }
  @media (max-width:980px){.wrap{grid-template-columns:1fr;height:auto;}}

  .panel,.alerts{ border:.1rem solid var(--ring); border-radius:var(--radius); box-shadow:var(--shadow); padding:2rem; }
  .panel{ background:var(--card); display:flex; flex-direction:column; justify-content:space-between; position:relative; }
  .header{ display:flex; flex-direction:column; align-items:flex-start; position:relative; margin-bottom:2rem; }
  h1{ margin:0; font-weight:900; font-size:clamp(1.5rem,2.5vw,2.7rem); letter-spacing:.02em; }

  select{
    padding:.6em 1em; border-radius:.7em; border:.1rem solid var(--ring); background:#fff; font-size:1rem;
    margin-top:2.5rem; margin-left:.2rem; min-width:14rem;
  }

  .metrics{ display:grid; grid-template-columns:repeat(3,1fr); gap:1rem; margin-top:2rem; }
  @media (max-width:900px){.metrics{grid-template-columns:repeat(2,1fr);}}
  @media (max-width:500px){.metrics{grid-template-columns:1fr;}}

  .metric{
    background:#f3f6fb; border:.1rem solid var(--ring); border-radius:.9rem; text-align:center;
    padding:1.4rem; min-height:10rem; display:flex; flex-direction:column; justify-content:space-between;
    transition:transform .2s ease;
  }
  .metric:hover{transform:translateY(-.2rem);}
  .metric h3{margin:0;font-size:1.2rem;font-weight:700;}
  .metric .value{font-size:1.4rem;font-weight:800;margin-top:auto;}

  .alerts{ background:var(--alert-bg); }
  .alerts h2{
    margin:0 0 1rem;
    font-size:clamp(1.3rem,2vw,1.8rem);
    font-weight:900;
    text-align:center;
  }

  .alert{ background:var(--warn); border:.1rem solid #f6caca; border-radius:.8rem; padding:1rem 1.2rem; margin-top:1rem; }
  .alert strong{margin-right:.4rem;}
  .time{display:block;margin-top:.3rem;color:var(--muted);font-size:.9rem;}
</style>
</head>
<body>
  <div class="wrap">
    <!-- Left panel -->
    <section class="panel" aria-label="Monitoring">
      <div class="header">
        <h1>Equipment Monitoring</h1>
        <label>
          <select id="deviceSelect" aria-label="Select equipment">
            <option disabled selected>Loading devicesâ€¦</option>
          </select>
        </label>
      </div>

      <div class="metrics">
        <div class="metric" aria-label="Temperature">
          <h3>Temperature</h3>
          <div class="value" id="tempVal">--</div>
        </div>
        <div class="metric" aria-label="Vibration">
          <h3>Vibration</h3>
          <div class="value" id="vibVal">--</div>
        </div>
        <div class="metric" aria-label="Pressure">
          <h3>Pressure</h3>
          <div class="value" id="presVal">--</div>
        </div>
      </div>
    </section>

    <!-- Right panel -->
    <aside class="alerts" aria-label="Active alerts">
      <h2>Active Alerts</h2>
      <div id="alertsList"></div>
    </aside>
  </div>

  <script src="https://cdn.socket.io/4.7.5/socket.io.min.js" crossorigin="anonymous"></script>
  <script>
  const API_BASE = "https://ml-api-ec2k.onrender.com";
  const RISK_THRESHOLD = 85;

  const sel = document.getElementById('deviceSelect');
  const alertsList = document.getElementById('alertsList');

  const els = {
    temp: document.getElementById('tempVal'),
    vib : document.getElementById('vibVal'),
    pres: document.getElementById('presVal'),
  };
  const fmt = {
    temp: v => `${Number(v).toFixed(1)} Â°C`,
    vib : v => `${Number(v).toFixed(2)} units`,
    pres: v => `${Number(v).toFixed(0)} psi`,
    clock: () => new Date().toLocaleTimeString('en-US', { hour12: true }),
  };

  let socket = null;
  let pollTimer = null;
  let devices = [];
  let usingSocket = false;          // ðŸ‘ˆ Ù†Ø³ØªØ®Ø¯Ù…Ù‡ Ù„Ù…Ø¹Ø±ÙØ© Ù‡Ù„ Ø§Ù„ÙˆÙŠØ¨ Ø³ÙˆÙƒØª Ø´ØºØ§Ù„
  const alertsMap = new Map();      // name -> {name, time, message, _ts}

  // ======= Alerts UI =======
  function renderAlerts(){
    alertsList.innerHTML = '';
    const alerts = Array.from(alertsMap.values());
    if (!alerts.length) return;
    alerts.sort((a,b) => b._ts - a._ts);
    for (const a of alerts) {
      const box = document.createElement('div');
      box.className = 'alert';
      box.innerHTML = `
        <strong>WARNING:</strong> ${a.message || `High failure risk detected on ${a.name}`}
        <span class="time">${a.time}</span>
      `;
      alertsList.appendChild(box);
    }
  }

  function upsertAlert(name, timeStr, message){
    if (message) {
      message = message
        .replace(/^Warning:\s*/i, '')
        .replace(/\s+at\s+\d{1,2}:\d{2}:\d{2}\s*(AM|PM)?/i, '')
        .trim();
    }
    alertsMap.set(name, { name, time: timeStr, message, _ts: Date.now() });
    renderAlerts();
  }

  function clearAlert(name){
    if (alertsMap.delete(name)) renderAlerts();
  }

  // ======= Data fetchers =======
  async function fetchLatest(name){
    try{
      const res = await fetch(`${API_BASE}/latest?equipment_name=${encodeURIComponent(name)}`);
      if(!res.ok) throw new Error(`HTTP ${res.status}`);
      const { ok, data } = await res.json();
      if (ok && data) return data;
      return null;
    } catch (err) {
      console.error('latest error:', err);
      return null;
    }
  }

  async function updateSelectedCards(){
    const name = sel.value;
    if (!name) return;
    const d = await fetchLatest(name);
    if (d){
      els.temp.textContent = fmt.temp(d.temperature);
      els.vib .textContent = fmt.vib (d.vibration);
      els.pres.textContent = fmt.pres(d.pressure);

      const risk = Number(d.risk_score || 0);
      const timeStr = d.timestamp ? new Date(d.timestamp).toLocaleTimeString() : fmt.clock();
      if (risk >= RISK_THRESHOLD) upsertAlert(name, timeStr, d.message);
    }
  }

  async function refreshAlertsForAllDevices(){
    if (!devices.length) return;
    const results = await Promise.all(devices.map(n => fetchLatest(n)));
    results.forEach((data, idx) => {
      const name = devices[idx];
      if (!data) return;
      const risk = Number(data.risk_score || 0);
      const timeStr = data.timestamp
        ? new Date(data.timestamp).toLocaleTimeString('en-US', { hour12: true })
        : fmt.clock();
      if (risk >= RISK_THRESHOLD) {
        upsertAlert(name, timeStr, data.message);
      } else {
        clearAlert(name);
      }
    });
  }

  // ======= Polling =======
  function startPolling(){
    if (pollTimer) return;
    console.log('[Polling] start');
    pollTimer = setInterval(async () => {
      await updateSelectedCards();
      await refreshAlertsForAllDevices();
    }, 5000);
  }

  function stopPolling(){
    if (!pollTimer) return;
    console.log('[Polling] stop');
    clearInterval(pollTimer);
    pollTimer = null;
  }

  // ======= Socket.IO =======
  function connectSocket(){
    if (!window.io) {
      console.warn('io() not found â†’ polling only');
      startPolling();
      return;
    }

    console.log('[Socket] connecting...');
    socket = io(API_BASE, {
      withCredentials: false,
      // ðŸ‘ˆ Ù†Ø®Ù„ÙŠ Socket.IO ÙŠØ­Ø§ÙˆÙ„ websocket Ø£ÙˆÙ„Ø§Ù‹ Ø«Ù… ÙŠØ±Ø¬Ø¹ Ù„Ù€ polling Ø¥Ø°Ø§ ÙØ´Ù„
      transports: ['websocket', 'polling'],
      timeout: 10000,
      reconnection: true,
      reconnectionAttempts: Infinity,
      reconnectionDelay: 1000,
      reconnectionDelayMax: 5000,
      path: '/socket.io'
    });

    socket.on('connect', () => {
      console.log('[Socket] connected', socket.id);
      usingSocket = true;
      // Ù…Ø¯Ø§Ù… Ø§Ù„ÙˆÙŠØ¨ Ø³ÙˆÙƒØª Ø´ØºØ§Ù„ Ù…Ø§ Ù†Ø­ØªØ§Ø¬ polling
      stopPolling();
    });

    socket.on('connect_error', e => {
      console.warn('[Socket] connect_error:', e?.message||e);
      if (!usingSocket) {
        // Ù…Ø§ Ù‚Ø¯Ø± ÙŠÙˆØµÙ„ Ø¨Ø§Ù„ÙˆÙŠØ¨ Ø³ÙˆÙƒØª â†’ Ù†Ø´ØªØºÙ„ polling
        startPolling();
      }
    });

    socket.on('disconnect', reason => {
      console.warn('[Socket] disconnected:', reason);
      usingSocket = false;
      // Ø¥Ø°Ø§ Ø§Ù†Ù‚Ø·Ø¹ Ø§Ù„ÙˆÙŠØ¨ Ø³ÙˆÙƒØª Ù†Ø±Ø¬Ø¹ Ù„Ù€ polling
      startPolling();
    });

    socket.on('reading_update', (msg) => {
    console.log('[Socket] reading_update:', msg);  // ðŸ‘ˆ Ù…Ù‡Ù… Ø¬Ø¯Ø§Ù‹
  
    // Ù…Ø¤Ù‚ØªÙ‹Ø§: Ø­Ø¯Ù‘Ø« Ø§Ù„ÙƒØ±ÙˆØª Ù„Ø£ÙŠ Ø±Ø³Ø§Ù„Ø© Ø¨Ø¯ÙˆÙ† Ø´Ø±Ø· Ø§Ù„Ù…Ø·Ø§Ø¨Ù‚Ø©
    els.temp.textContent = fmt.temp(msg.temperature);
    els.vib .textContent = fmt.vib (msg.vibration);
    els.pres.textContent = fmt.pres(msg.pressure);
  
    const risk = Number(msg?.risk_score || 0);
    const timeStr = msg?.date || fmt.clock();
    const name = String(msg?.equipment_name || '').trim();
    if (!name) return;
  
    if (risk >= RISK_THRESHOLD) {
      upsertAlert(name, timeStr, msg?.message);
    } else {
      clearAlert(name);
    }
  });

  }

  // ======= Boot =======
  async function loadDevices() {
    const setOpt = (txt) => sel.innerHTML = `<option disabled selected>${txt}</option>`;
    setOpt('Loading devicesâ€¦');

    try { await fetch(`${API_BASE}/`, { mode:'cors' }); } catch {}

    async function fetchWithTimeout(url, ms = 9000) {
      const c = new AbortController();
      const t = setTimeout(() => c.abort(), ms);
      try {
        return await fetch(url, {
          headers: { 'Accept': 'application/json' },
          mode: 'cors',
          signal: c.signal
        });
      } finally { clearTimeout(t); }
    }

    const maxTries = 6;
    for (let i = 1; i <= maxTries; i++) {
      try {
        const res = await fetchWithTimeout(`${API_BASE}/equipment`, 9000);
        if (!res.ok) throw new Error(`HTTP ${res.status}`);
        const json = await res.json();
        const arr = Array.isArray(json?.equipment) ? json.equipment : [];
        devices = arr;

        sel.innerHTML = '';
        if (!devices.length) { setOpt('No devices found'); return; }

        for (const name of devices) sel.add(new Option(name, name));
        sel.selectedIndex = 0;

        await updateSelectedCards();
        await refreshAlertsForAllDevices();
        return;
      } catch (e) {
        console.warn(`[loadDevices] try ${i} failed:`, e?.message || e);
        setOpt(i === 1 ? 'Warming up serverâ€¦' : `Retryingâ€¦ (${i}/${maxTries})`);
        await new Promise(r => setTimeout(r, i * 1000));
      }
    }

    setOpt('Could not load devices (server waking up)â€¦');
  }

  sel.addEventListener('change', async () => {
    els.temp.textContent = els.vib.textContent = els.pres.textContent = '--';
    await updateSelectedCards();
  });

  document.addEventListener('DOMContentLoaded', async () => {
    await loadDevices();

    // Ù†Ø­Ø§ÙˆÙ„ Ù†ØªØµÙ„ Ø¨Ø§Ù„ÙˆÙŠØ¨ Ø³ÙˆÙƒØª Ø£ÙˆÙ„Ø§Ù‹
    connectSocket();

    // Ù†Ø´ØºÙ‘Ù„ polling ÙƒØ¨Ø¯Ø§ÙŠØ© (Ù„ÙŠÙ† Ù…Ø§ ÙŠØªØµÙ„ Ø§Ù„ÙˆÙŠØ¨ Ø³ÙˆÙƒØª)
    startPolling();
  });
  </script>
</body>
</html>

